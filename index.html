<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coviello's Day</title>
    <style>
        :root { --gold: #ffd700; --parchment: #fffdf0; --border: #3d251e; --purple: #9b59b6; --leaf: #4a7c44; }
        body { background: #000; color: white; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-wrap { position: relative; border: 6px solid var(--border); image-rendering: pixelated; }
        canvas { display: block; background: #000; transition: opacity 1s; }
        #ui-bar { width: 600px; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #1a0f0c; border: 4px solid var(--border); border-bottom: none; }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: bold; color: #f0e68c; }
        #blackjack-ui, #dialogue-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2d1b16; border: 6px solid var(--gold); padding: 25px; display: none; pointer-events: auto; text-align: center; width: 400px; z-index: 200; }
        #dialogue-box { background: var(--parchment); color: #222; border: 6px solid var(--border); width: 450px; text-align: left; transition: all 0.2s; }
        #dialogue-box.ending-mode { width: 500px; bottom: 10px; top: auto; transform: translateX(-50%); padding: 15px; border-width: 3px; }
        .card-row { display: flex; justify-content: center; gap: 10px; margin: 15px 0; min-height: 80px; }
        .card { width: 50px; height: 75px; background: white; color: black; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; border: 3px solid #000; }
        .btn { background: #d2691e; color: white; border: none; padding: 10px 15px; cursor: pointer; font-family: inherit; font-size: 15px; font-weight: bold; border-bottom: 4px solid #8b4513; margin: 5px; }
        .btn:hover { background: #ff7f50; }
        .btn:disabled { background: #555; opacity: 0.5; cursor: not-allowed; }
        .hint { position: absolute; bottom: 80px; width: 100%; text-align: center; font-weight: bold; pointer-events: none; text-shadow: 2px 2px #000; font-size: 20px; color: gold; }
        #perks-display { position: absolute; bottom: 10px; left: 10px; font-size: 12px; color: #aaa; pointer-events: none; }
        .lang-toggle { background: #3d251e; color: #ffd700; border: 2px solid #ffd700; cursor: pointer; padding: 2px 8px; font-family: inherit; font-weight: bold; }
    </style>
</head>
<body>

    <div id="ui-bar">
        <div class="stat-item"><canvas id="coinIcon" width="20" height="20"></canvas><span id="gold-val">100</span></div>
        <div class="stat-item"><canvas id="visitorIcon" width="20" height="20"></canvas><span id="visit-val">0</span></div>
        <div style="font-size: 16px; color: #fff; opacity: 0.6;" id="room-name">BAZAAR</div>
        <div class="stat-item"><canvas id="giftIcon" width="20" height="20"></canvas><span id="gift-val">0</span>
            <button class="lang-toggle" onclick="toggleLang()" style="margin-left: 15px;">EN/UA</button>
        </div>
    </div>
    
    <div id="game-wrap">
        <canvas id="gameCanvas" width="600" height="600"></canvas>
        <div id="perks-display"></div>
        
        <div id="blackjack-ui">
            <h2 id="bj-msg" style="color:var(--gold); margin:0;">BLACKJACK</h2>
            <div id="dealer-hand" class="card-row"></div>
            <div id="player-hand" class="card-row"></div>
            <button id="hit-btn" class="btn" onclick="hit()">HIT (H)</button>
            <button id="stand-btn" class="btn" onclick="stand()">STAND (S)</button>
        </div>

        <div id="dialogue-box">
            <div id="diag-name" style="color:var(--purple); font-size: 14px; margin-bottom: 5px; font-weight: bold;"></div>
            <div id="diag-text" style="font-size: 19px; font-weight: bold; min-height: 60px;"></div>
            <div id="diag-btns" style="margin-top:20px; text-align:right; border-top: 1px solid #ccc; padding-top: 10px;"></div>
        </div>

        <div class="hint" id="interact-hint" style="display:none;">Press [E] or [Enter]</div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- TRANSLATIONS
    let curLang = 'en';
    const t = {
        en: {
            hint: "Press [E] or [Enter]",
            rooms: { CENTER: "BAZAAR", LEFT: "SHOP", RIGHT: "ELION'S PILLOWS", GARDEN: "GARDEN", ROMANTIC: "MOONLIGHT", GOD_FIELD: "VOID" },
            perks: { tired: "üí§ Tired", happy: "‚ö° Happy", gilded: "üí∞ Gilded Tongue", oracle: "üëÅÔ∏è Oracle's Help" },
            ui: { leave: "Leave", exit: "Exit", back: "Back", next: "Next", thanks: "Thanks!", buy: "Buy", alright: "Alright" },
            roles: { shopper: "SHOPPER", gambler: "GAMBLER", debt: "COLLECTOR", kiddo: "KIDDO", kiren: "KIREN", jesse: "JESSE", rainbow: "RAINBOW" },
            radio: { name: "OLD RADIO", off: "The radio hums quietly. It looks very old.", on: "Currently playing: Track ", btnOn: "Turn On", btnOff: "Turn Off", btnNext: "Next Track" },
            kiddo: { name: "KIDDO", ask: "'Mister, mister! Have you seen the Enchanted Candy at the shop? Can you get me one? Pleeease?'", give: "Hand over candy", refuse: "I don't have any candy.", thanks: "'WOW! It really is magic! Thank you!'", skip: "She skips away.", meanie: "'MEANIE! I'M TELLING THE WITCH GUY YOU'RE A SCAMMER.'" },
            collector: { name: "COLLECTOR", tax: "'Bazaar protection tax: 100 Gold. Don't make this difficult, Coviello.'", pay: "Pay 100G", refuse: "Refuse to pay.", wait: "Understood." },
            elion: { 
                name: "ELION THE WITCH", 
                angry: "'Coviello! I heard you were scamming a child! I'm taking my magic back until you prove you've changed.'",
                explain: "Wait, I can explain!",
                cold: "'My magic is cold today, Coviello. Don't ask for much.'",
                chatBtn: "Chat more", goldBtn: "Ask Gold", giftBtn: "Give Gift",
                noMagic: "'I have no energy. My heart is too cold right now.'",
                rich: "'You still have coin, Cov. Save my magic for when you're truly broke.'",
                giveGold: "'*Sigh*... I suppose I can spare some magic for you. Here.'",
                stayCozy: "Stay cozy.",
                giftResponse: (item) => `'A ${item}? Thoughtful.'`
            },
            merchant: { name: "THE MERCHANT", buyBtn: (n, c) => `${n} (${c}G)`, noGold: "'No gold!'", bought: (n) => `'Bought ${n}!'` },
            bj: { hit: "HIT (H)", stand: "STAND (S)", win: "WIN", lose: "LOSE", draw: "DRAW" },
            rainbow: { name: "RAINBOW", deck: "'EWWW... What are these cards?? Let's play with my super cool magic Rainbow Deck! ;3'" },
            jesse: { name: "JESSE", yell: "'YOOO, ELIONNN!! I'M STILL ALIVE AND SOUND! YOUR CARDS ARE TELLIN' F##### BULL###T! HAHA!'", calm: "...Calm down." },
            kiren: { name: "KIREN", hi: "'Hey! Glad to see the stall doing well. Tell Elion i said hi!'", bye: "Safe travels!" },
             god: {
                name: "???",
                line1: "You have reached the edge of existence, Coviello. Why?",
                opt1: "I seek truth.",
                opt2: "I got lost.",
                line2: "Truth is a heavy burden for a mortal.",
                line3: "You are not supposed to be here. This is not your story.",
                line4: "Go back. Do not atempt to prevent what is inevitable.",
                line5: "Remember. I am always watching."
            },
            ending: {
                e1: "'I finally understand why you love this view so much, Coviello.'",
                c1: "'It's not just the view. It's the peace... the kind I only find when I'm with you.'",
                e2: "'You're so stubborn. All those flowers and gifts... I suppose I should reward you.'",
                c2: "'I love you, Elie.'",
                e3: "'...I love you too.'",
                c3: "'Huh?'",
                e4: "'Don't make me say it again, it's exhausting.'",
                fin: "The End"
            }
        },
        ua: {
            hint: "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å [E] –∞–±–æ [Enter]",
            rooms: { CENTER: "–ë–ê–ó–ê–†", LEFT: "–ö–†–ê–ú–ù–ò–¶–Ø", RIGHT: "–ü–û–ö–û–á –ï–õ–Ü–û–ù–ê", GARDEN: "–°–ê–î", ROMANTIC: "–ú–Ü–°–Ø–ß–ù–ï –°–Ø–ô–í–û", GOD_FIELD: "–ü–û–†–û–ñ–ù–ï–ß–ê" },
            perks: { tired: "üí§ –í—Ç–æ–º–ª–µ–Ω–∏–π", happy: "‚ö° –©–∞—Å–ª–∏–≤–∏–π", gilded: "üí∞ –ö—Ä–∞—Å–Ω–æ–º–æ–≤—Å—Ç–≤–æ", oracle: "üëÅÔ∏è –î–æ–ø–æ–º–æ–≥–∞ –û—Ä–∞–∫—É–ª–∞" },
            roles: { shopper: "–ü–û–ö–£–ü–ï–¶–¨", gambler: "–ì–†–ê–í–ï–¶–¨", debt: "–ó–ë–ò–†–ê–ß", kiddo: "–î–ò–¢–ò–ù–ê", kiren: "–ö–Ü–†–ï–ù", jesse: "–î–ñ–ï–°–°–Ü", rainbow: "–†–ï–ô–ù–ë–û–£" },
            ui: { leave: "–ü—ñ—Ç–∏", exit: "–í–∏—Ö—ñ–¥", back: "–ù–∞–∑–∞–¥", next: "–î–∞–ª—ñ", thanks: "–î—è–∫—É—é!", buy: "–ö—É–ø–∏—Ç–∏", alright: "–ì–∞—Ä–∞–∑–¥" },
            radio: { name: "–°–¢–ê–†–ï –†–ê–î–Ü–û", off: "–†–∞–¥—ñ–æ —Ç–∏—Ö–æ –≥—É–¥–µ. –í–æ–Ω–æ –≤–∏–≥–ª—è–¥–∞—î –¥—É–∂–µ —Å—Ç–∞—Ä–∏–º.", on: "–ó–∞—Ä–∞–∑ –≥—Ä–∞—î: –¢—Ä–µ–∫ ", btnOn: "–£–≤—ñ–º–∫–Ω—É—Ç–∏", btnOff: "–í–∏–º–∫–Ω—É—Ç–∏", btnNext: "–ù–∞—Å—Ç—É–ø–Ω–∏–π" },
            kiddo: { name: "–î–ò–¢–ò–ù–ê", ask: "'–ü–∞–Ω–µ, –ø–∞–Ω–µ! –í–∏ –±–∞—á–∏–ª–∏ —á–∞—Ä—ñ–≤–Ω—ñ —Ü—É–∫–µ—Ä–∫–∏ –≤ –∫—Ä–∞–º–Ω–∏—Ü—ñ? –ö—É–ø–∏—Ç–µ –º–µ–Ω—ñ –æ–¥–Ω—É? –ë—É–¥—å –ª–∞–∞–∞—Å–∫–∞!'", give: "–í—ñ–¥–¥–∞—Ç–∏ —Ü—É–∫–µ—Ä–∫—É", refuse: "–£ –º–µ–Ω–µ –Ω–µ–º–∞—î —Ü—É–∫–µ—Ä–æ–∫.", thanks: "'–û–ì–û! –í–æ–Ω–∏ —Å–ø—Ä–∞–≤–¥—ñ —á–∞—Ä—ñ–≤–Ω—ñ! –î—è–∫—É—é!'", skip: "–í–æ–Ω–∞ –≤—Ç—ñ–∫–∞—î, –ø—ñ–¥—Å—Ç—Ä–∏–±—É—é—á–∏.", meanie: "'–ñ–ê–î–Æ–ì–ê! –Ø —Ä–æ–∑–∫–∞–∂—É —Ç–≤–æ—ó–π –≤—ñ–¥—å–º—ñ, —â–æ —Ç–∏ —à–∞—Ö—Ä–∞–π!'" },
            collector: { name: "–ó–ë–ò–†–ê–ß", tax: "'–ü–æ–¥–∞—Ç–æ–∫ –∑–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω–Ω—è –±–∞–∑–∞—Ä—É: 100 –∑–æ–ª–æ—Ç–∏—Ö. –ù–µ —É—Å–∫–ª–∞–¥–Ω—é–π —Ü–µ, –ö–æ–≤'—î–ª–ª–æ.'", pay: "–°–ø–ª–∞—Ç–∏—Ç–∏ 100–ó", refuse: "–í—ñ–¥–º–æ–≤–∏—Ç–∏—Å—å.", wait: "–ó—Ä–æ–∑—É–º—ñ–≤." },
            elion: { 
                name: "–ï–õ–Ü–û–ù", 
                angry: "'–ö–æ–≤'—î–ª–ª–æ! –Ø–∫ —Ç–∏ –º—ñ–≥ –æ–±—ñ–∫—Ä–∞—Å—Ç–∏ –±—ñ–¥–Ω—É –¥–∏—Ç–∏–Ω—É?! –Ø –∑–∞–±–∏—Ä–∞—é —Å–≤–æ—é –º–∞–≥—ñ—é, –ø–æ–∫–∏ —Ç–∏ –Ω–µ –¥–æ–≤–µ–¥–µ—à, —â–æ –∑–º—ñ–Ω–∏–≤—Å—è.'",
                explain: "–ß–µ–∫–∞–π, —è –ø–æ—è—Å–Ω—é!",
                cold: "'–ú–æ—è –º–∞–≥—ñ—è —Å—å–æ–≥–æ–¥–Ω—ñ —Ö–æ–ª–æ–¥–Ω–∞, –ö–æ–≤'—î–ª–ª–æ. –ù–µ –ø—Ä–æ—Å–∏ –±–∞–≥–∞—Ç–æ.'",
                chatBtn: "–ü–æ–≥–æ–≤–æ—Ä–∏—Ç–∏", goldBtn: "–ü—Ä–æ—Å–∏—Ç–∏ –∑–æ–ª–æ—Ç–∞", giftBtn: "–î–∞—Ç–∏ –¥–∞—Ä—É–Ω–æ–∫",
                noMagic: "'–£ –º–µ–Ω–µ –Ω–µ–º–∞—î —Å–∏–ª. –ú–æ—î —Å–µ—Ä—Ü–µ –∑–∞—Ä–∞–∑ –∑–∞–Ω–∞–¥—Ç–æ —Ö–æ–ª–æ–¥–Ω–µ.'",
                rich: "'–£ —Ç–µ–±–µ —â–µ —î –º–æ–Ω–µ—Ç–∏, –ö–æ–≤. –ë–µ—Ä–µ–∂–∏ –º–æ—é –º–∞–≥—ñ—é –∫–æ–ª–∏ —Ç–∏ —Å–ø—Ä–∞–≤–¥—ñ –Ω–µ –º–∞—Ç–∏–º–µ—à –∫–æ–ø—ñ–π–∫–∏.'",
                giveGold: "'–ï—Ö—Ö... –ì–∞–¥–∞—é, —è –º–æ–∂—É –≤–∏–¥—ñ–ª–∏—Ç–∏ —Ç–æ–±—ñ —Ç—Ä–æ—Ö–∏ –º–∞–≥—ñ—ó. –¢—Ä–∏–º–∞–π.'",
                stayCozy: "–í—ñ–¥–ø–æ—á–∏–≤–∞–π.",
                giftResponse: (item) => `'${item}? –Ø–∫ –º–∏–ª–æ –∑ —Ç–≤–æ–≥–æ –±–æ–∫—É.'`
            },
            merchant: { name: "–¢–û–†–ì–û–í–ï–¶–¨", buyBtn: (n, c) => `${n} (${c}–ó)`, noGold: "'–ù–µ–º–∞—î –∑–æ–ª–æ—Ç–∞!'", bought: (n) => `'–ö—É–ø–ª–µ–Ω–æ: ${n}!'` },
            bj: { hit: "–©–ï (H)", stand: "–î–û–°–ò–¢–¨ (S)", win: "–ü–ï–†–ï–ú–û–ì–ê", lose: "–ü–†–û–ì–†–ê–®", draw: "–ù–Ü–ß–ò–Ø" },
            rainbow: { name: "–†–ï–ô–ù–ë–û–£", deck: "'–§–ï–ï–ï... –©–æ —Ü–µ –∑–∞ –∫–∞—Ä—Ç–∏?? –î–∞–≤–∞–π—Ç–µ –∑—ñ–≥—Ä–∞—î–º–æ –º–æ—î—é —Å—É–ø–µ—Ä-–∫—Ä—É—Ç–æ—é –º–∞–≥—ñ—á–Ω–æ—é –í–µ—Å–µ–ª–∫–æ–≤–æ—é –ö–æ–ª–æ–¥–æ—é! ;3'" },
            jesse: { name: "–î–ñ–ï–°–°–Ü", yell: "'–ô–û–£, –ï–õ–Ü–û–ù! –Ø –í–°–ï –©–ï –ñ–ò–í–ò–ô –Ü –ó–î–û–†–û–í–ò–ô, –ï–õ–Ü–û–ù!!1!1 –¢–í–û–á –ö–ê–†–¢–ò –¶–ï –á##### #####'", calm: "...–ó–∞—Å–ø–æ–∫–æ–π—Å—è." },
            kiren: { name: "–ö–Ü–†–ï–ù", hi: "'–ì–µ–π! –†–∞–¥–∏–π –±–∞—á–∏—Ç–∏, —â–æ —Å–ø—Ä–∞–≤–∏ –π–¥—É—Ç—å –¥–æ–±—Ä–µ. –ü–µ—Ä–µ–¥–∞–≤–∞–π –ï–ª—ñ–æ–Ω—É –ø—Ä–∏–≤—ñ—Ç!'", bye: "–©–∞—Å–ª–∏–≤–æ—ó –¥–æ—Ä–æ–≥–∏!" },
            god: {
                name: "???",
                line1: "–¢–∏ –¥–æ—Å—è–≥ –∫—Ä–∞—é –±—É—Ç—Ç—è, –ö–æ–≤'—î–ª–ª–æ. –ß–æ–º—É?",
                opt1: "–®—É–∫–∞—é —ñ—Å—Ç–∏–Ω—É.",
                opt2: "–Ø –∑–∞–±–ª—É–∫–∞–≤.",
                line2: "–Ü—Å—Ç–∏–Ω–∞ ‚Äî –≤–∞–∂–∫–∞ –Ω–æ—à–∞ –¥–ª—è —Å–º–µ—Ä—Ç–Ω–æ–≥–æ.",
                line3: "–¢–∏ –Ω–µ –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ —Ç—É—Ç. –¶–µ –Ω–µ —Ç–≤–æ—è –ø–æ–≤—ñ—Å—Ç—å.",
                line4: "–ü–æ–≤–µ—Ä—Ç–∞–π—Å—è. –ù–µ –Ω–∞–º–∞–≥–∞–π—Å—è –ø—Ä–æ—Ç–∏–¥—ñ—è—Ç–∏ –Ω–µ–º–∏–Ω—É—á–æ–º—É.",
                line5: "–ü–∞–º'—è—Ç–∞–π. –Ø –∑–∞–≤–∂–¥–∏ —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—é."
            },
            ending: {
                e1: "'–¢–µ–ø–µ—Ä —è —Ä–æ–∑—É–º—ñ—é, —á–æ–º—É —Ç–∏ —Ç–∞–∫ –ª—é–±–∏—à —Ü–µ–π –∫—Ä–∞—î–≤–∏–¥, –ö–æ–≤'—î–ª–ª–æ.'",
                c1: "'–¶–µ –Ω–µ —Ç—ñ–ª—å–∫–∏ –∫—Ä–∞—î–≤–∏–¥. –¶–µ —Å–ø–æ–∫—ñ–π... —è–∫–∏–π —è –∑–Ω–∞—Ö–æ–¥–∂—É –ª–∏—à–µ –ø–æ—Ä—É—á —ñ–∑ —Ç–æ–±–æ—é.'",
                e2: "'–¢–∏ —Ç–∞–∫–∏–π –≤–ø–µ—Ä—Ç–∏–π. –í—Å—ñ —Ü—ñ –∫–≤—ñ—Ç–∏ —Ç–∞ –ø–æ–¥–∞—Ä—É–Ω–∫–∏... –¢–∏ —Ç–∞–∫ —Å—Ç–∞—Ä–∞–≤—Å—è. –ì–∞–¥–∞—é, —è –º–∞—é —Ç–µ–±–µ –≤–∏–Ω–∞–≥–æ—Ä–æ–¥–∏—Ç–∏.'",
                c2: "'–Ø –∫–æ—Ö–∞—é —Ç–µ–±–µ, –ï–ª—ñ.'",
                e3: "'...–Ø —Ç–µ–∂ —Ç–µ–±–µ –∫–æ—Ö–∞—é.'",
                c3: "'–ì–∞?'",
                e4: "'–ù–µ –∑–º—É—à—É–π –º–µ–Ω–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏, —Ü–µ –≤–∏—Å–Ω–∞–∂—É—î.'",
                fin: "–ö—ñ–Ω–µ—Ü—å"
            }
        }
    };

    function toggleLang() {
        curLang = curLang === 'en' ? 'ua' : 'en';
        document.getElementById('interact-hint').innerText = t[curLang].hint;
        document.getElementById('hit-btn').innerText = t[curLang].bj.hit;
        document.getElementById('stand-btn').innerText = t[curLang].bj.stand;
    }

    // Backgrounds
    const bgBazaar = new Image(); bgBazaar.src = 'input_file_0.png'; 
    const bgElion = new Image(); bgElion.src = 'input_file_1.png';
    const bgShop = new Image(); bgShop.src = 'input_file_2.png';
    const bgGarden = new Image(); bgGarden.src = 'garden.png';
    const bgRomantic = new Image(); bgRomantic.src = 'romantic.png'; 
    const bgGodField = new Image(); bgGodField.src = 'input_file_3.png';

    // Characters
    const sprCoviello = new Image(); sprCoviello.src = 'coviello.png';
    const sprElion = new Image();    sprElion.src = 'elion.png';
    const sprMerchant = new Image(); sprMerchant.src = 'merchant.png';
    const sprCust1 = new Image();    sprCust1.src = 'customer1.png';
    const sprCust2 = new Image();    sprCust2.src = 'customer2.png';
    const sprCust3 = new Image();    sprCust3.src = 'customer3.png';
    const sprCollector = new Image(); sprCollector.src = 'collector.png';
    const sprKiren = new Image();    sprKiren.src = 'kiren.png';
    const sprKiddo = new Image();    sprKiddo.src = 'kiddo.png';
    const sprJesse = new Image();    sprJesse.src = 'jesse.png';
    const sprRainbow = new Image();  sprRainbow.src = 'rainbow.png';
    const sprExplosion = new Image(); sprExplosion.src = 'explosion.png';
    
    // God Characters
    const sprGod1 = new Image(); sprGod1.src = 'god1.png'; 
    const sprGod2 = new Image(); sprGod2.src = 'god2.png'; 

    let gold = 100, inventory = [], room = 'CENTER', state = 'WALK';
    let elionSat = 40, visitorCount = 0; 
    let lastCustTime = Date.now(), lastFlowerTime = Date.now(), keys = {};
    const player = { x: 300, y: 450, color: '#4a6fa5', isMoving: false, speed: 4 };
    let customer = null, flowers = [], elionGhost = null, explosionEffect = null;
    let kiddoTattling = false;
    let isRainbowRound = false;
    let pHand = [], dHand = [], deck = [];
    
    // God scene variables
    let offScreenTimer = 0;
    let godSequenceActive = false;
    let godTimer = 0;
    let godForm = 1;
    let godVisible = false;
    let godDialogueStep = 0;
    let godInteractable = false;

    // --- MUSIC
    const tracks = ['track1.mp3', 'track2.mp3', 'track3.mp3', 'track4.mp3', 'track5.mp3', 'track6.mp3', 'track7.mp3', 'track8.mp3','track9.mp3', 'track10.mp3'];
    let currentTrackIdx = 0;
    let isMusicPlaying = false;
    const audioPlayer = new Audio();
    const radioPos = { x: 125, y: 220, w: 40, h: 30 };

    audioPlayer.onended = () => { skipTrack(); };

    function toggleMusic() {
        if (!isMusicPlaying) {
            audioPlayer.src = tracks[currentTrackIdx];
            audioPlayer.play().catch(e => console.log("Audio blocked."));
            isMusicPlaying = true;
        } else {
            audioPlayer.pause();
            isMusicPlaying = false;
        }
        openRadioMenu(); 
    }

    function skipTrack() {
        currentTrackIdx = (currentTrackIdx + 1) % tracks.length;
        if (isMusicPlaying) {
            audioPlayer.src = tracks[currentTrackIdx];
            audioPlayer.play();
        }
        openRadioMenu();
    }

    const masterItems = [
        {name: "Enchanted Candy", cost: 15, sat: 5},
        {name: "Starlight Tea", cost: 40, sat: 15},
        {name: "Cosmic Scarf", cost: 80, sat: 25},
        {name: "Silk Pillow", cost: 60, sat: 20},
        {name: "Ancient Coin", cost: 100, sat: 25},
        {name: "Rare Spices", cost: 30, sat: 10}
    ];

    function drawIcons() {
        const cCtx = document.getElementById('coinIcon').getContext('2d'); cCtx.fillStyle = '#ffd700'; cCtx.fillRect(2, 2, 16, 16);
        const vCtx = document.getElementById('visitorIcon').getContext('2d'); vCtx.fillStyle = '#fff'; vCtx.fillRect(6, 2, 8, 8); vCtx.fillRect(4, 10, 12, 8);
        const gCtx = document.getElementById('giftIcon').getContext('2d'); gCtx.fillStyle = '#8e44ad'; gCtx.fillRect(2, 4, 16, 14);
    }
    drawIcons();

    // --- BUTTONS
    window.onkeydown = e => {
        keys[e.code] = true; 
        const isInteractKey = (e.code === 'KeyE' || e.code === 'Enter' || e.code === 'NumpadEnter');

        if (state === 'WALK' && isInteractKey) {
            e.preventDefault();
            handleInteraction();
        }
        if (state === 'GOD_READY' && isInteractKey) {
            e.preventDefault();
            startGodDialogue();
        }
        if (state === 'ENDING' && isInteractKey) {
            e.preventDefault();
            advanceEnding();
        }
        if (state === 'BJ') {
            if (e.code === 'KeyH') hit();
            if (e.code === 'KeyS') stand();
        }
    };
    window.onkeyup = e => keys[e.code] = false;


   function checkCollision(nx, ny) {
    
        if (state !== 'WALK' && state !== 'GOD_READY') return true;
        if (room === 'CENTER') {
            if (nx < 10 && ny < 200) return true;
            if (nx > 600 && ny < 180) return true;
            if (ny > 160 && ny < 260 && nx > 60 && nx < 540) return true; // table centre
            if (ny > 260 && ny < 350 && nx > 60 && nx < 140) return true; //table left
            if (ny > 260 && ny < 290 && nx > 410 && nx < 460) return true; // vase
            if (ny > 260 && ny < 350 && nx > 460 && nx < 540) return true; // table right
            if (ny > 510 && nx > 60 && nx < 540) return true; // table down
            if (customer && customer.state === 'WAIT' && Math.hypot(nx - customer.x, ny - customer.y) < 50) return true;
            if (ny > 580) return true;
        }
        if (room === 'RIGHT') {
            if (nx < 160 && ny < 120) return true; 
            if (nx > 160 && nx < 450 && ny < 70) return true;
            if (nx > 410 && ny < 100) return true;
            if (nx > 230 && nx < 375 && ny > 160 && ny < 400) return true; 
            if (Math.hypot(nx - 500, ny - 520) < 60) return true; 
            if (ny > 580) return true; 
            if (nx > 590) return true; 
        }
        if (room === 'LEFT') { 
            if (ny < 200 || ny > 580) return true; 
            if (ny < 240 && nx > 130 && nx < 500) return true;
             if (Math.hypot(nx - 300, ny - 260) < 60) return true;} 
        if (room === 'GARDEN') { if (ny < 100 || ny > 580 || nx < 20 || nx > 580) { if (ny > 580 && nx > 50 && nx < 500) return false; return true; } }
        if (room === 'GOD_FIELD') { if (ny < 300 || ny > 580) return true;}
        return false;
    }

   function handleInteraction() {
        if (room === 'CENTER' && Math.hypot(player.x - radioPos.x, player.y - radioPos.y) < 100) return openRadioMenu();
        if (room === 'CENTER' && customer?.state === 'WAIT' && Math.abs(player.y - customer.y) < 150) {
            if (customer.role === 'DEBT') return startDebtEncounter();
            if (customer.role === 'KIREN') return startKirenEncounter();
            if (customer.role === 'KIDDO') return startKiddoEncounter();
            if (customer.role === 'JESSE') return startJesseEncounter();
            if (customer.role === 'RAINBOW') return startRainbowEncounter();
            if (customer.role === 'GAMBLER') return startBJ();
            return startSale();
        }
        if (room === 'RIGHT' && Math.hypot(player.x - 500, player.y - 520) < 120) return openElionMenu();
        if (room === 'LEFT' && player.y < 450 && Math.abs(player.x - 300) < 150) return openShop();
        if (room === 'GARDEN') { flowers = flowers.filter(f => { if (Math.hypot(player.x - f.x, player.y - f.y) < 40) { inventory.push("Wildflower"); document.getElementById('gift-val').innerText = inventory.length; return false; } return true; }); }
        if (room === 'GOD_FIELD' && godInteractable && Math.hypot(player.x - 300, player.y - 200) < 150) return startGodDialogue();
    }

    function openRadioMenu() {
        state = 'DIALOGUE';
        const box = document.getElementById('dialogue-box'); box.style.display = 'block';
        document.getElementById('diag-name').innerText = t[curLang].radio.name;
        document.getElementById('diag-text').innerText = isMusicPlaying ? t[curLang].radio.on + (currentTrackIdx + 1) : t[curLang].radio.off;
        let btns = `<button class="btn" onclick="toggleMusic()">${isMusicPlaying ? t[curLang].radio.btnOff : t[curLang].radio.btnOn}</button>`;
        btns += `<button class="btn" onclick="skipTrack()">${t[curLang].radio.btnNext}</button>`;
        btns += `<button class="btn" style="background:#555" onclick="closeDiag()">${t[curLang].ui.leave}</button>`;
        document.getElementById('diag-btns').innerHTML = btns;
    }

    function startRainbowEncounter() {
        state = 'DIALOGUE'; document.getElementById('dialogue-box').style.display = 'block';
        document.getElementById('diag-name').innerText = t[curLang].rainbow.name;
        document.getElementById('diag-text').innerText = t[curLang].rainbow.deck;
        document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="startRainbowRound()">${t[curLang].ui.alright}</button><button class="btn" onclick="finishSale()">${t[curLang].ui.leave}</button>`;
    }
    function startRainbowRound() { closeDiag(); isRainbowRound = true; startBJ(); }

    function startJesseEncounter() {
        state = 'DIALOGUE'; document.getElementById('dialogue-box').style.display = 'block';
        document.getElementById('diag-name').innerText = t[curLang].jesse.name;
        document.getElementById('diag-text').innerText = t[curLang].jesse.yell;
        document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="finishSale()">${t[curLang].jesse.calm}</button>`;
    }

    function startKiddoEncounter() {
        state = 'DIALOGUE'; document.getElementById('dialogue-box').style.display = 'block';
        document.getElementById('diag-name').innerText = t[curLang].kiddo.name;
        document.getElementById('diag-text').innerText = t[curLang].kiddo.ask;
        let hasCandy = inventory.includes("Enchanted Candy");
        let btns = hasCandy ? `<button class="btn" onclick="giveCandy()">${t[curLang].kiddo.give}</button>` : "";
        btns += `<button class="btn" onclick="refuseKiddo()">${t[curLang].kiddo.refuse}</button>`;
        document.getElementById('diag-btns').innerHTML = btns;
    }
    function giveCandy() { inventory.splice(inventory.indexOf("Enchanted Candy"), 1); document.getElementById('gift-val').innerText = inventory.length; document.getElementById('diag-text').innerText = t[curLang].kiddo.thanks; document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="finishSale()">${t[curLang].kiddo.skip}</button>`; }
    function refuseKiddo() { document.getElementById('diag-text').innerText = t[curLang].kiddo.meanie; document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="kiddoRunsAway()">${t[curLang].ui.back}</button>`; }
    function kiddoRunsAway() { closeDiag(); if(customer) { customer.state = 'OUT'; customer.targetX = 700; } kiddoTattling = true; }

    function startDebtEncounter() {
        state = 'DIALOGUE'; document.getElementById('dialogue-box').style.display = 'block';
        document.getElementById('diag-name').innerText = t[curLang].collector.name;
        document.getElementById('diag-text').innerText = t[curLang].collector.tax;
        let btns = gold >= 100 ? `<button class="btn" onclick="payDebt()">${t[curLang].collector.pay}</button>` : `<button class="btn" disabled>...</button>`;
        btns += `<button class="btn" onclick="triggerIntervention()">${t[curLang].collector.refuse}</button>`;
        document.getElementById('diag-btns').innerHTML = btns;
    }
    function payDebt() { gold -= 100; document.getElementById('gold-val').innerText = gold; finishSale(); }
    function triggerIntervention() { closeDiag(); state = 'INTERVENTION'; elionGhost = { x: 500, y: 520, targetX: 230, targetY: 140, opacity: 0, stage: 'TELEPORT' }; elionSat = Math.max(0, elionSat - 50); }

    function startSale() {
        state = 'DIALOGUE'; document.getElementById('dialogue-box').style.display = 'block';
        let profit = elionSat >= 50 ? (Math.floor(Math.random() * 11) + 15) : (Math.floor(Math.random() * 11) + 5); 
        gold += profit; document.getElementById('gold-val').innerText = gold;
        document.getElementById('diag-name').innerText = t[curLang].roles.shopper;
        const lines = curLang === 'en' ? [
            `'These spices... they smell like the mountains of my childhood. I'll pay ${profit} gold for the whole jar.'`,
            `'This fabric is woven so tightly! It will make a fine cloak. Here, ${profit} gold for your skill.'`,
            `'I've looked all over the bazaar, but your goods are the finest. Please, take this ${profit} gold.'`,
            `'A rare find indeed! I didn't expect to see such quality today. Here is ${profit} gold.'`,
            `'I suppose this will suffice. Here is ${profit} gold.'`,
            `'Your saffron is the best out of here, Coviello. Take this ${profit} gold.'`,
            `'This necklace looks ancient! Please, take this ${profit} gold.'`,
            `'Whatever this is, it smells amazing. Here is your ${profit} gold.'`,
            `'She will be so happy... Thank you and here is your ${profit} gold.'`,
            `'I'll buy this small trinket. Here is ${profit} gold.'`,
            `'This thing looks so cool, damn... There you go, ${profit} gold'`
        ] : [
            `'–¶—ñ —Å–ø–µ—Ü—ñ—ó... –≤–æ–Ω–∏ –ø–∞—Ö–Ω—É—Ç—å –≥–æ—Ä–∞–º–∏ –º–æ–≥–æ –¥–∏—Ç–∏–Ω—Å—Ç–≤–∞. –Ø –∑–∞–ø–ª–∞—á—É ${profit} –∑–æ–ª–æ—Ç–∞ –∑–∞ –≤—Å—é –±–∞–Ω–∫—É.'`,
            `'–¶—è —Ç–∫–∞–Ω–∏–Ω–∞ —Ç–∞–∫ —â—ñ–ª—å–Ω–æ –≤–∏—Ç–∫–∞–Ω–∞! –ó –Ω–µ—ó –≤–∏–π–¥–µ —á—É–¥–æ–≤–∏–π –ø–ª–∞—â. –û—Å—å, ${profit} –∑–æ–ª–æ—Ç–∞ –∑–∞ —Ç–≤–æ—é –º–∞–π—Å—Ç–µ—Ä–Ω—ñ—Å—Ç—å.'`,
            `'–Ø –æ–±—ñ–π—à–æ–≤ –≤–µ—Å—å –±–∞–∑–∞—Ä, –∞–ª–µ –≤–∞—à—ñ —Ç–æ–≤–∞—Ä–∏ –Ω–∞–π–∫—Ä–∞—â—ñ. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—ñ–∑—å–º—ñ—Ç—å —Ü—ñ ${profit} –∑–æ–ª–æ—Ç–∞.'`,
            `'–°–ø—Ä–∞–≤–¥—ñ —Ä—ñ–¥–∫—ñ—Å–Ω–∞ –∑–Ω–∞—Ö—ñ–¥–∫–∞! –ù–µ —Å–ø–æ–¥—ñ–≤–∞–≤—Å—è –ø–æ–±–∞—á–∏—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ —Ç–∞–∫—É —è–∫—ñ—Å—Ç—å. –¢—Ä–∏–º–∞–π ${profit} –∑–æ–ª–æ—Ç–∞.'`,
            `'–ì–∞–¥–∞—é, —Ü–µ –∑–≥–æ–¥–∏—Ç—å—Å—è. –¢–≤–æ—ó ${profit} –∑–æ–ª–æ—Ç–∞.'`,
            `'–¢–≤—ñ–π —à–∞—Ñ—Ä–∞–Ω –Ω–∞–π–∫—Ä–∞—â–∏–π –∑ —É—Å—ñ—Ö, —â–æ —Ç—É—Ç —î, –ö–æ–≤'—î–ª–ª–æ. –¢—Ä–∏–º–∞–π ${profit} –∑–æ–ª–æ—Ç–∞.'`,
            `'–¶–µ –Ω–∞–º–∏—Å—Ç–æ –≤–∏–≥–ª—è–¥–∞—î —Å—Ç–∞—Ä–æ–≤–∏–Ω–Ω–∏–º! –ë—É–¥—å –ª–∞—Å–∫–∞, –≤—ñ–∑—å–º–∏ —Ü—ñ ${profit} –∑–æ–ª–æ—Ç–∞.'`,
            `'–©–æ –± —Ü–µ –Ω–µ –±—É–ª–æ, –≤–æ–Ω–æ –ø–∞—Ö–Ω–µ –ø—Ä–µ—á—É–¥–æ–≤–æ. –û—Å—å –≤–∞–º ${profit} –∑–æ–ª–æ—Ç–∞.'`,
            `'–í–æ–Ω–∞ –±—É–¥–µ —Ç–∞–∫–∞ —â–∞—Å–ª–∏–≤–∞... –î—è–∫—É—é, –æ—Å—å –≤–∞–º ${profit} –∑–æ–ª–æ—Ç–∞.'`,
            `'–Ø –∫—É–ø–ª—é —Ü—é –¥—Ä—ñ–±–Ω–∏—á–∫—É. –û—Å—å ${profit} –∑–æ–ª–æ—Ç–∞.'`,
            `'–¶—è —Ä—ñ—á –≤–∏–≥–ª—è–¥–∞—î —Ç–∞–∫ –∫—Ä—É—Ç–æ, —á–æ—Ä—Ç... –û—Å—å –≤–∞—à—ñ, ${profit} –∑–æ–ª–æ—Ç–∞.'`
        ];
        document.getElementById('diag-text').innerText = lines[Math.floor(Math.random()*lines.length)];
        document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="finishSale()">${t[curLang].ui.thanks}</button>`;
    }
    function finishSale() { closeDiag(); if(customer) customer.state = 'OUT'; }
    function startKirenEncounter() { state = 'DIALOGUE'; document.getElementById('dialogue-box').style.display = 'block'; document.getElementById('diag-name').innerText = t[curLang].kiren.name; document.getElementById('diag-text').innerText = t[curLang].kiren.hi; document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="finishSale()">${t[curLang].kiren.bye}</button>`; }

    // GOD DIALOGUE
    function startGodDialogue() {
        state = 'GOD_DIALOGUE';
        godDialogueStep = 1;
        document.getElementById('dialogue-box').style.display = 'block';
        advanceGodDialogue();
    }
    
    function advanceGodDialogue() {
        const text = document.getElementById('diag-text'), name = document.getElementById('diag-name'), btns = document.getElementById('diag-btns');
        name.innerText = t[curLang].god.name;
        
        if (godDialogueStep === 1) {
            text.innerText = t[curLang].god.line1;
            btns.innerHTML = `<button class="btn" onclick="godDialogueStep++; advanceGodDialogue()">${t[curLang].god.opt1}</button>
                             <button class="btn" onclick="godDialogueStep++; advanceGodDialogue()">${t[curLang].god.opt2}</button>`;
        } else if (godDialogueStep === 2) {
            text.innerText = t[curLang].god.line2;
            btns.innerHTML = `<button class="btn" onclick="godDialogueStep++; advanceGodDialogue()">${t[curLang].ui.next}</button>`;
        } else if (godDialogueStep === 3) {
            text.innerText = t[curLang].god.line3;
            btns.innerHTML = `<button class="btn" onclick="godDialogueStep++; advanceGodDialogue()">${t[curLang].ui.next}</button>`;
        } else if (godDialogueStep === 4) {
            text.innerText = t[curLang].god.line4;
            btns.innerHTML = `<button class="btn" onclick="godDialogueStep++; advanceGodDialogue()">${t[curLang].ui.next}</button>`;
        } else if (godDialogueStep === 5) {
            text.innerText = t[curLang].god.line5;
            btns.innerHTML = `<button class="btn" onclick="endGodScene()">${t[curLang].ui.leave}</button>`;
        }
    }
    
    function endGodScene() {
        closeDiag();
        godVisible = false;
        godSequenceActive = false;
        godInteractable = false;
        state = 'WALK';
    }

    function update() {
        if (state === 'ENDING') return;
        
        // --- GOD FIELD TRANSITION
        if (room === 'LEFT' && player.x < -10) {
            offScreenTimer++;
            if (offScreenTimer > 1200) {  //—á–∞—Å –¥–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç—É ~ 17 —Å–µ–∫
                room = 'GOD_FIELD';
                player.x = 300;
                offScreenTimer = 0;
                godSequenceActive = true;
                godTimer = 0;
                godForm = 1;
                godVisible = true;
                godInteractable = false;
                state = 'GOD_WAIT';
            }
        } else if (room === 'GOD_FIELD' && (player.x < -10 || player.x > 610)) {
            offScreenTimer++;
            if (offScreenTimer > 900) { //—á–∞—Å –¥–ª—è —Ç–µ–ª–µ–ø–æ—Ä—Ç—É 15 —Å–µ–∫
                room = 'LEFT';
                player.x = 50;
                offScreenTimer = 0;
            }
        } else {
            offScreenTimer = 0;
        }
        
        // --- GOD SEQUENCE LOGIC ---
        if (godSequenceActive && state === 'GOD_WAIT') {
            godTimer++;
            if (godTimer > 700) { // Form 1 stays for 5 seconds
                godForm = 2;
                godInteractable = true;
                state = 'GOD_READY';
            }
        }

        if (state === 'INTERVENTION') {
            if (elionGhost.stage === 'TELEPORT') { elionGhost.opacity += 0.02; if (elionGhost.opacity >= 1) { elionGhost.x = elionGhost.targetX; elionGhost.y = elionGhost.targetY; elionGhost.stage = 'CHARGE'; elionGhost.timer = 120; } }
            else if (elionGhost.stage === 'CHARGE') { elionGhost.timer--; if (elionGhost.timer <= 0) { elionGhost.stage = 'BLAST'; explosionEffect = { x: customer.x, y: customer.y, size: 0, alpha: 1 }; } }
            else if (elionGhost.stage === 'BLAST') { customer.x += 4; explosionEffect.size += 3; if (customer.x > 700) elionGhost.stage = 'FADE'; }
            else if (elionGhost.stage === 'FADE') { elionGhost.opacity -= 0.015; explosionEffect.alpha -= 0.01; if (elionGhost.opacity <= 0) { state = 'WALK'; elionGhost = null; explosionEffect = null; customer = null; lastCustTime = Date.now(); } }
            return;
        }

        if (state !== 'WALK' && state !== 'GOD_WAIT' && state !== 'GOD_READY') return;
        if (elionSat >= 25) player.speed = 6; else if (elionSat < 20) player.speed = 2.5; else player.speed = 4;
        let perkList = [];
        if (elionSat < 20) perkList.push(t[curLang].perks.tired);
        if (elionSat >= 25) perkList.push(t[curLang].perks.happy);
        if (elionSat >= 50) perkList.push(t[curLang].perks.gilded);
        if (elionSat >= 75) perkList.push(t[curLang].perks.oracle);
        document.getElementById('perks-display').innerText = perkList.join(" | ");

        let mx = 0, my = 0;
        if (keys['KeyW'] || keys['ArrowUp']) my -= player.speed; 
        if (keys['KeyS'] || keys['ArrowDown']) my += player.speed; 
        if (keys['KeyA'] || keys['ArrowLeft']) mx -= player.speed; 
        if (keys['KeyD'] || keys['ArrowRight']) mx += player.speed;
        
        if (!checkCollision(player.x + mx, player.y + my)) { player.x += mx; player.y += my; player.isMoving = (mx !== 0 || my !== 0); } else player.isMoving = false;
        
        if (player.x < -15) { if (room === 'CENTER') { room = 'LEFT'; player.x = 580; } else if (room === 'RIGHT') { room = 'CENTER'; player.x = 580; } } 
        else if (player.x > 615) { if (room === 'CENTER') { room = 'RIGHT'; player.x = 20; } else if (room === 'LEFT') { room = 'CENTER'; player.x = 20; } } 
        else if (player.y < -15 && room === 'CENTER') { room = 'GARDEN'; player.y = 570; }
        else if (player.y > 615 && room === 'GARDEN') { room = 'CENTER'; player.y = 50; }

        if (room === 'CENTER' && !customer && Date.now() - lastCustTime > 7000) {
            let r = Math.random();
            let role = 'SHOPPER';
            if (r < 0.02) role = 'RAINBOW'; else if (r < 0.06) role = 'DEBT'; else if (r < 0.08) role = 'KIREN'; else if (r < 0.08) role = 'JESSE'; else if (r < 0.15) role = 'KIDDO'; else if (r < 0.5) role = 'GAMBLER';
            let skins = [sprCust1, sprCust2, sprCust3];
            let skin = skins[Math.floor(Math.random()*3)];
            if(role==='DEBT') skin=sprCollector; if(role==='KIREN') skin=sprKiren; if(role==='KIDDO') skin=sprKiddo; if(role==='JESSE') skin=sprJesse; if(role==='RAINBOW') skin=sprRainbow;
            customer = { x: 300, y: -50, targetY: 140, state: 'IN', role: role, skin: skin, bet: Math.floor(Math.random()*40)+10 };
        }
        if (customer) {
            if (customer.state === 'IN') { customer.y += 2; if(customer.y >= customer.targetY) { customer.state = 'WAIT'; visitorCount++; document.getElementById('visit-val').innerText = visitorCount; } }
            else if (customer.state === 'OUT') { if(customer.targetX) customer.x += 4; else customer.y -= 3; if(customer.y < -50 || customer.x > 650) { customer = null; lastCustTime = Date.now(); } }
        }
        if (room === 'GARDEN' && flowers.length < 5 && Date.now() - lastFlowerTime > 10000) { flowers.push({x: 50 + Math.random()*500, y: 150 + Math.random()*350, c: `hsl(${Math.random()*360}, 70%, 60%)`}); lastFlowerTime = Date.now(); }
        //location of charctrs
        const nearFlower = room === 'GARDEN' && flowers.some(f => Math.hypot(player.x - f.x, player.y - f.y) < 40);
        const nearCust = room === 'CENTER' && customer?.state === 'WAIT' && Math.abs(player.y - customer.y) < 150;
        const nearElion = room === 'RIGHT' && Math.hypot(player.x - 500, player.y - 520) < 120;
        const nearShop = room === 'LEFT' && player.y < 450 && Math.abs(player.x - 300) < 150;
        const nearRadio = room === 'CENTER' && Math.hypot(player.x - radioPos.x, player.y - radioPos.y) < 100;
        const nearGod = room === 'GOD_FIELD' && godInteractable && Math.hypot(player.x - 300, player.y - 200) < 150;

        document.getElementById('interact-hint').style.display = (nearFlower || nearCust || nearElion || nearShop || nearRadio || nearGod) ? 'block' : 'none';
        document.getElementById('room-name').innerText = t[curLang].rooms[room] || room;
        if (elionSat >= 100) triggerEnding();
    }

    function triggerEnding() {
        state = 'ENDING'; canvas.style.opacity = '0';
        setTimeout(() => { room = 'ROMANTIC'; canvas.style.opacity = '1'; document.getElementById('ui-bar').style.display = 'none'; document.getElementById('dialogue-box').classList.add('ending-mode'); player.x = 250; player.y = 450; openEndingDialogue(); }, 1000);
    }
    let endStep = 0;
    function openEndingDialogue() { document.getElementById('dialogue-box').style.display = 'block'; advanceEnding(); }
    function advanceEnding() {
        const text = document.getElementById('diag-text'), name = document.getElementById('diag-name'), btns = document.getElementById('diag-btns');
        endStep++;
        if (endStep === 1) { name.innerText = t[curLang].elion.name.split(' ')[0]; text.innerText = t[curLang].ending.e1; btns.innerHTML = `<button class="btn" onclick="advanceEnding()">${t[curLang].ui.next}</button>`; }
        else if (endStep === 2) { name.innerText = "COVIELLO"; text.innerText = t[curLang].ending.c1; }
        else if (endStep === 3) { name.innerText = t[curLang].elion.name.split(' ')[0]; text.innerText = t[curLang].ending.e2; }
        else if (endStep === 4) { name.innerText = "COVIELLO"; text.innerText = t[curLang].ending.c2; }
        else if (endStep === 5) { name.innerText = t[curLang].elion.name.split(' ')[0]; text.innerText = t[curLang].ending.e3; }
        else if (endStep === 6) { name.innerText = "COVIELLO"; text.innerText = t[curLang].ending.c3; }
        else if (endStep === 7) { name.innerText = t[curLang].elion.name.split(' ')[0]; text.innerText = t[curLang].ending.e4; btns.innerHTML = `<button class="btn" onclick="location.reload()">${t[curLang].ending.fin}</button>`; }
    }

    function draw() {
        ctx.clearRect(0,0,600,600);
        if (room === 'CENTER') { 
            ctx.drawImage(bgBazaar, 0, 0, 600, 600); 
            ctx.fillStyle = '#5d4037'; ctx.fillRect(radioPos.x-15, radioPos.y-10, 30, 20); 
            ctx.fillStyle = isMusicPlaying ? '#0f0' : '#444'; ctx.beginPath(); ctx.arc(radioPos.x+10, radioPos.y, 2, 0, Math.PI*2); ctx.fill(); 
            if (customer) {
                let lbl = customer.role === 'GAMBLER' ? (curLang==='en'?'GAMBLER':'–ì–†–ê–í–ï–¶–¨') + ` (${customer.bet})` : (t[curLang].roles[customer.role.toLowerCase()] || customer.role);
                drawEntity(customer.skin, customer.x, customer.y, lbl, customer.state !== 'WAIT', '#e74c3c'); 
            }
        }
        else if (room === 'RIGHT') { ctx.drawImage(bgElion, 0, 0, 600, 600); drawEntity(sprElion, 500, 520, t[curLang].elion.name, false, '#2ecc71'); ctx.fillStyle = "#222"; ctx.fillRect(450, 440, 100, 6); ctx.fillStyle = elionSat > 30 ? "#9b59b6" : "#e74c3c"; ctx.fillRect(450, 440, elionSat, 6); }
        else if (room === 'LEFT') { ctx.drawImage(bgShop, 0, 0, 600, 600); drawEntity(sprMerchant, 300, 260, t[curLang].merchant.name, false, '#9b59b6'); }
        else if (room === 'GARDEN') { if (bgGarden.complete) ctx.drawImage(bgGarden, 0, 0, 600, 600); flowers.forEach(f => { ctx.fillStyle = f.c; ctx.beginPath(); ctx.arc(f.x, f.y, 8, 0, Math.PI*2); ctx.fill(); }); }
        else if (room === 'ROMANTIC') { if (bgRomantic.complete) ctx.drawImage(bgRomantic, 0, 0, 600, 600); drawEntity(sprElion, 350, 450, t[curLang].elion.name, false, '#2ecc71'); }
        else if (room === 'GOD_FIELD') {
            if (bgGodField.complete && bgGodField.naturalWidth > 0) ctx.drawImage(bgGodField, 0, 0, 600, 600);
            else { ctx.fillStyle = "#000511"; ctx.fillRect(0, 0, 600, 600); }
            
            if (godVisible) {
                let godImg = godForm === 1 ? sprGod1 : sprGod2;
                drawEntity(godImg, 300, 200, t[curLang].god.name, false, "#fff");
            }
        }
        
        if (elionGhost) { ctx.globalAlpha = elionGhost.opacity; drawEntity(sprElion, elionGhost.x, elionGhost.y, t[curLang].elion.name, false, '#9b59b6'); ctx.globalAlpha = 1; }
        if (explosionEffect) { ctx.globalAlpha = explosionEffect.alpha; if (sprExplosion.complete) ctx.drawImage(sprExplosion, explosionEffect.x - explosionEffect.size/2, explosionEffect.y - explosionEffect.size/2, explosionEffect.size, explosionEffect.size); ctx.globalAlpha = 1; }
        drawEntity(sprCoviello, player.x, player.y, 'COVIELLO', player.isMoving, '#4a6fa5');
    }

    function drawEntity(img, x, y, name, walk, color) {
        let b = walk ? Math.sin(Date.now()/120) * 6 : 0;
        let s = 90;
        let shakeX = 0, shakeY = 0;
        if (name.includes("JESSE") || name.includes("–î–ñ–ï–°–°–Ü")) { shakeX = (Math.random()-0.5)*6; shakeY = (Math.random()-0.5)*6; }
        if (!img || !img.complete || img.naturalWidth === 0) { ctx.fillStyle = color; ctx.fillRect(x-30+shakeX, y-30+b+shakeY, 60, 60); }
        else { ctx.drawImage(img, x - (s/2) + shakeX, y - (s/2) + b + shakeY, s, s); }
        ctx.fillStyle = 'white'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.fillText(name, x+shakeX, y - 55 + b + shakeY);
    }

    function openElionMenu() {
        state = 'DIALOGUE'; const box = document.getElementById('dialogue-box'); box.style.display = 'block'; document.getElementById('diag-name').innerText = "ELION THE WITCH";
        if (kiddoTattling) { document.getElementById('diag-text').innerText = t[curLang].elion.angry; elionSat = 0; kiddoTattling = false; document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="closeDiag()">${t[curLang].elion.explain}</button>`; return; }
        let pool = curLang === 'en' ?[
            "'Ah, Coviello... my favorite distraction. What is it?'",
            "'The moon is low, but my eyelids are lower... What do you want?'",
            "'Magic is just a shortcut for people who don't want to walk. I've taken many shortcuts today.'",
            "'You smell like bazaar dust and ambition. It's... a grounding scent.'",
            "'Did you hear the bazaar gossip? Apparently, someone tried to pay with lead painted gold.'",
            "'Careful where you step, Coviello. I'm testing a new luck charm on the floor.'"
        ]
        : ["'–ê, –ö–æ–≤'—î–ª–ª–æ... –º—ñ–π –ª—é–±–∏–π –¥—Ä—É–∂–µ. –©–æ—Å—å —Ç—Ä–∞–ø–∏–ª–æ—Å—å?'",
            "'–ú—ñ—Å—è—Ü—å —Å—å–æ–≥–æ–Ω—ñ –Ω–∏–∑—å–∫–æ, –ø—Ä–æ—Ç–µ –º–æ—ó –ø–æ–≤—ñ–∫–∏ –Ω–∏–∂—á–µ... –¢–∏ —â–æ—Å—å —Ö–æ—Ç—ñ–≤?'",
            "'–ú–∞–≥—ñ—è —Ü–µ –ø—Ä–æ—Å—Ç–æ —Ä—è—Ç—É–Ω–æ–∫ –¥–ª—è –ª—é–¥–µ–π —è–∫—ñ –Ω–µ —Ö–æ—á–µ—Ç—å —Ö–æ–¥–∏—Ç–∏. –ê –º–µ–Ω—ñ –¥—É–∂–µ –Ω–µ —Ö–æ—á–µ—Ç—å—Å—è —Ö–æ–¥–∏—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ.'",
            "'–¢–∏ –ø–∞—Ö–Ω–µ—à –ø–∏–ª–æ–º –±–∞–∑–∞—Ä—É —Ç–∞ –∞–º–±—ñ—Ü—ñ—è–º–∏. –¶–µ... –∑–∞–∑–µ–º–ª—é—é—á–∏–π –∞—Ä–æ–º–∞—Ç.'",
            "'–¢–∏ —á—É–≤ –±–∞–∑–∞—Ä–Ω—ñ –ø–ª—ñ—Ç–∫–∏? –ö–∞–∂—É—Ç—å, —Ö—Ç–æ—Å—å –Ω–∞–º–∞–≥–∞–≤—Å—è –∑–∞–ø–ª–∞—Ç–∏—Ç–∏ —Å–≤–∏–Ω—Ü–µ–º, –ø–æ—Ñ–∞—Ä–±–æ–≤–∞–Ω–∏–º –ø–æ–¥ –∑–æ–ª–æ—Ç–æ.'",
            "'–î–∏–≤–∏—Å—å –ø—ñ–¥ –Ω–æ–≥–∏ –ö–æ–≤'—î–ª–ª–æ. –Ø –≤–∏–ø—Ä–æ–±–æ–≤—É—é –Ω–æ–≤—ñ —Ç–∞–ª—ñ—Å–º–∞–Ω–∏.'"
        ]
        document.getElementById('diag-text').innerText = elionSat > 0 ? pool[Math.floor(Math.random()*pool.length)] : "'My magic is cold today, Coviello. Don't ask for much.'";
        document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="elionChat()">${t[curLang].elion.chatBtn}</button><button class="btn" onclick="elionRequestGold()">${t[curLang].elion.goldBtn}</button>` + (inventory.length > 0 ? `<button class="btn" onclick="elionGiveGift()">${t[curLang].elion.giftBtn}</button>` : "") + `<button class="btn" style="background:#555" onclick="closeDiag()">${t[curLang].ui.leave}</button>`;
    }
    function elionChat() { 
        const chats = curLang === 'en' ? [
        "'The stars whispered your name earlier. Or maybe it was just a draft.'", 
        "'Magic is exhausting, but seeing you running around makes it a bit more bearable.'", 
        "'The bazaar sounds busy today.'", 
        "'It's so nice to rest in the pillows. Wish you could join, lol.'", 
        "'You're like a persistent little beetle. Always scurrying about for coin.'", 
        "'I could fix your luck with a spell, but the ingredients are all the way across the room... so, no.'", 
        "'Coviello, why don't we have dinner with Juliet? My hands yearn for artefacts rather than a frying pan today.'", 
        "'The Merchant's 'rare tea' is just dried grass from my garden. Don't tell him I know.'",
        "'I wonder how's Kiren doing... This much stress can't be good for him.'",
        "'Oh dear Coviello! My hat is wet from the rain. Throw it on the window, please.'",
        "'Profit is the sun that never sets in this bazaar, huh? How greedy of him. Not that you're better.'"
    ] 
    : ["'–ó—ñ—Ä–∫–∏ —à–µ–ø–æ—Ç—ñ–ª–∏ —Ç–≤–æ—î —ñ–º'—è —Ä–∞–Ω—ñ—à–µ... –ê–±–æ —Ü–µ –±—É–≤ –ø—Ä–æ—Å—Ç–æ –≤—ñ—Ç–µ—Ä.'", 
        "'–ú–∞–≥—ñ—è –≤–∏—Å–Ω–∞–∂—É—î, –∞–ª–µ –∫–æ–ª–∏ —è –±–∞—á—É —è–∫ —Ç–∏ –≥–∞—Å–∞—î—à, —Å—Ç–∞—î —Ç—Ä–æ—Ö–∏ –ª–µ–≥—à–µ.'", 
        "'–ë–∞–∑–∞—Ä —Å—å–æ–≥–æ–¥–Ω—ñ, –∑–¥–∞—î—Ç—å—Å—è, –¥—É–∂–µ –∂–≤–∞–≤–∏–π.'", 
        "'–ú—Ö, —Ç–∞–∫ –ø—Ä–∏—î–º–Ω–æ –≤—ñ–¥–ø–æ—á–∏–≤–∞—Ç–∏ –≤ –ø–æ–¥—É—à–∫–∞—Ö. –®–∫–æ–¥–∞, —â–æ —Ç–∏ –Ω–µ –º–æ–∂–µ—à –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å, –ª–æ–ª'", 
        "'–¢–∏ —è–∫ –Ω–∞–ø–æ–ª–µ–≥–ª–∏–≤–∞ –º–∞–ª–µ–Ω—å–∫–∞ –±–¥–∂—ñ–ª–∫–∞. –ó–∞–≤–∂–¥–∏ –±—ñ–≥–∞—î—à –∑–∞ –≥—Ä–æ—à–∏–º–∞.'", 
        "'–Ø –º—ñ–≥ –±–∏ –ø–æ–ª—ñ–ø—à–∏—Ç–∏ —Ç–≤–æ—é —É–¥–∞—á—É —á–∞—Ä–∞–º–∏, –∞–ª–µ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –ª–µ–∂–∞—Ç—å –Ω–∞ —ñ–Ω—à–æ–º—É –∫—ñ–Ω—Ü—ñ –∫—ñ–º–Ω–∞—Ç–∏... —Ç–æ–º—É, –Ω—ñ.'", 
        "'–ö–æ–≤'—î–ª–ª–æ, –Ω—É–º–æ –ø–æ–≤–µ—á–µ—Ä—è—î–º–æ —É –î–∂—É–ª—å—î—Ç? –ú–æ—ó —Ä—É–∫–∏ —Ç—è–≥–Ω—É—Ç—å—Å—è –¥–æ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ñ–≤ –∞ –Ω–µ —Å–∫–æ–≤–æ—Ä—ñ–¥–∫–∏ —Å—å–æ–≥–æ–¥–Ω—ñ.'", 
        "''–†—ñ–¥–∫—ñ—Å–Ω–∏–π —á–∞–π' —Ç–æ—Ä–≥–æ–≤—Ü—è ‚Äî —Ü–µ –ø—Ä–æ—Å—Ç–æ —Å—É—à–µ–Ω–∞ —Ç—Ä–∞–≤–∞ –∑ –º–æ–≥–æ —Å–∞–¥—É. –ù–µ –∫–∞–∂–∏ –π–æ–º—É, —â–æ —è –∑–Ω–∞—é.'",
        "'–¶—ñ–∫–∞–≤–æ, —è–∫ —Ç–∞–º –ö—ñ—Ä–µ–Ω... –°—Ç—ñ–ª—å–∫–∏ —Å—Ç—Ä–µ—Å—É –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –¥–ª—è –Ω—å–æ–≥–æ –∑–¥–æ—Ä–æ–≤–∏–º.'",
        "'–û—Ö, –¥–æ—Ä–æ–≥–∏–π –ö–æ–≤'—î–ª–ª–æ! –ú—ñ–π –∫–∞–ø–µ–ª—é—Ö –º–æ–∫—Ä–∏–π –≤—ñ–¥ –¥–æ—â—É. –ó–∞–∫–∏–Ω—å –π–æ–≥–æ –Ω–∞ –≤—ñ–∫–Ω–æ, –±—É–¥—å –ª–∞—Å–∫–∞.'",
        "'–ü—Ä–∏–±—É—Ç–æ–∫ ‚Äî —Ü–µ —Å–æ–Ω—Ü–µ, —è–∫–µ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞—Ö–æ–¥–∏—Ç—å –Ω–∞ —Ü—å–æ–º—É –±–∞–∑–∞—Ä—ñ, –≥–∞? –Ø–∫–∏–π –∂ –≤—ñ–Ω –∫–æ—Ä–∏—Å–ª–∏–≤–∏–π. –ù–µ —Ç–µ —â–æ–± —Ç–∏ –±—É–≤ –∫—Ä–∞—â–∏–º, —Ö–µ—Ö–µ.'"
    ];
        document.getElementById('diag-text').innerText = chats[Math.floor(Math.random()*chats.length)]; 
    }
    function elionRequestGold() { 
        if (elionSat <= 0) { document.getElementById('diag-text').innerText = t[curLang].elion.noMagic; }
        else if (gold >= 50) { document.getElementById('diag-text').innerText = t[curLang].elion.rich; }
        else { elionSat = Math.max(0, elionSat - 30); gold += 50; document.getElementById('gold-val').innerText = gold; document.getElementById('diag-text').innerText = t[curLang].elion.giveGold; }
    }
    function elionGiveGift() { const itemObj = inventory.shift(); const itemInfo = masterItems.find(i => i.name === itemObj); elionSat = Math.min(100, elionSat + (itemInfo ? itemInfo.sat : 5)); document.getElementById('gift-val').innerText = inventory.length; document.getElementById('diag-text').innerText = t[curLang].elion.giftResponse(itemObj); }

    function openShop() {
        state = 'SHOP'; document.getElementById('dialogue-box').style.display = 'block'; document.getElementById('diag-name').innerText = t[curLang].merchant.name;
        document.getElementById('diag-text').innerText = "...";
        const stock = [{name: "Enchanted Candy", cost: 15}, {name: "Starlight Tea", cost: 40}, {name: "Cosmic Scarf", cost: 80}];
        let btns = ""; stock.forEach(item => { btns += `<button class="btn" onclick="buy('${item.name}', ${item.cost})">${t[curLang].merchant.buyBtn(item.name, item.cost)}</button>`; });
        btns += `<button class="btn" style="background:#555" onclick="closeDiag()">${t[curLang].ui.exit}</button>`;
        document.getElementById('diag-btns').innerHTML = btns;
    }
    function buy(name, price) { if (gold >= price) { gold -= price; inventory.push(name); document.getElementById('gold-val').innerText = gold; document.getElementById('gift-val').innerText = inventory.length; document.getElementById('diag-text').innerText = t[curLang].merchant.bought(name); } else document.getElementById('diag-text').innerText = t[curLang].merchant.noGold; }
    function closeDiag() { document.getElementById('dialogue-box').style.display = 'none'; state = 'WALK'; }

    function hit() { if (state !== 'BJ') return; pHand.push(deck.pop()); renderBJ(); if (getSum(pHand) > 21) endBJ('LOSE'); }
    function stand() { if (state !== 'BJ') return; while(getSum(dHand) < 17) dHand.push(deck.pop()); renderBJ(); let p = getSum(pHand), d = getSum(dHand); if (d > 21 || p > d) endBJ('WIN'); else if (p < d) endBJ('LOSE'); else endBJ('DRAW'); }
    function getSum(h) { let s = h.reduce((a,b)=>a+b.w, 0), aces = h.filter(c=>c.x==='A').length; while(s > 21 && aces > 0) { s -= 10; aces--; } return s; }
    function startBJ() { if (gold < customer.bet) return alert(t[curLang].merchant.noGold); state = 'BJ'; document.getElementById('blackjack-ui').style.display = 'block'; pHand = []; dHand = []; deck = []; const v = ['2','3','4','5','6','7','8','9','10','J','Q','K','A']; for(let i=0; i<4; i++) v.forEach(x => deck.push({x, w: isNaN(x)?(x==='A'?11:10):parseInt(x)})); deck.sort(() => Math.random() - 0.5); pHand = [deck.pop(), deck.pop()]; dHand = [deck.pop(), deck.pop()]; renderBJ(); }
    function renderBJ() { 
        const pR = document.getElementById('player-hand'), dR = document.getElementById('dealer-hand'); pR.innerHTML = ''; dR.innerHTML = ''; 
        pHand.forEach(c => { const rbStyle = isRainbowRound ? 'background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%); border: 3px solid #ff00ff;' : ''; pR.innerHTML += `<div class="card" style="${rbStyle}">${c.x}</div>`; }); 
        dHand.forEach((c,i) => { let h = (i===1 && state==='BJ' && elionSat < 75); const rbStyle = isRainbowRound ? 'background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%); border: 3px solid #ff00ff;' : ''; dR.innerHTML += `<div class="card" style="${h?'background:#333':rbStyle}">${h?'?':c.x}</div>`; }); 
    }
    function endBJ(res) { 
        state = 'BJ_RESULT'; document.getElementById('bj-msg').innerText = t[curLang].bj[res.toLowerCase()]; 
        gold += (res === 'WIN' ? customer.bet : (res === 'LOSE' ? -customer.bet : 0)); 
        document.getElementById('gold-val').innerText = gold; 
        setTimeout(() => { document.getElementById('blackjack-ui').style.display = 'none'; if(customer) customer.state = 'OUT'; state = 'WALK'; isRainbowRound = false; }, 1500); 
    }

    function loop() { update(); draw(); requestAnimationFrame(loop); }
    loop();
</script>
    
    <script>
    var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track1.mp3');
    audio.play();
    var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track2.mp3');
    audio.play();
        var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track3.mp3');
    audio.play();
        var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track4.mp3');
    audio.play();
        var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track5.mp3');
    audio.play();
    var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track6.mp3');
    audio.play();
        var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track7.mp3');
    audio.play();
    var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track8.mp3');
    audio.play();
        var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track9.mp3');
    audio.play();
    var audio = new Audio(`https://github.com/ykeno/coviellosday/raw/refs/heads/main/track10.mp3');
    audio.play();
       
</script>

</body>
</html>
