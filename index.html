<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coviello's Bazaar: Cosmic Bonds</title>
    <style>
        :root { --gold: #ffd700; --parchment: #fffdf0; --border: #3d251e; --purple: #9b59b6; --leaf: #4a7c44; }
        body { background: #000; color: white; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        #game-wrap { position: relative; border: 6px solid var(--border); image-rendering: pixelated; }
        canvas { display: block; background: #000; transition: opacity 1s; }
        #ui-bar { width: 600px; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #1a0f0c; border: 4px solid var(--border); border-bottom: none; }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: bold; color: #f0e68c; }
        #blackjack-ui, #dialogue-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #2d1b16; border: 6px solid var(--gold); padding: 25px; display: none; pointer-events: auto; text-align: center; width: 400px; z-index: 200; }
        #dialogue-box { background: var(--parchment); color: #222; border: 6px solid var(--border); width: 450px; text-align: left; transition: all 0.5s; }
        #dialogue-box.ending-mode { width: 500px; bottom: 10px; top: auto; transform: translateX(-50%); padding: 15px; border-width: 3px; }
        .card-row { display: flex; justify-content: center; gap: 10px; margin: 15px 0; min-height: 80px; }
        .card { width: 50px; height: 75px; background: white; color: black; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 24px; border: 3px solid #000; }
        .btn { background: #d2691e; color: white; border: none; padding: 10px 15px; cursor: pointer; font-family: inherit; font-size: 15px; font-weight: bold; border-bottom: 4px solid #8b4513; margin: 5px; }
        .btn:hover { background: #ff7f50; }
        .btn:disabled { background: #555; opacity: 0.5; cursor: not-allowed; }
        .hint { position: absolute; bottom: 80px; width: 100%; text-align: center; font-weight: bold; pointer-events: none; text-shadow: 2px 2px #000; font-size: 20px; color: gold; }
        #perks-display { position: absolute; bottom: 10px; left: 10px; font-size: 12px; color: #aaa; pointer-events: none; }
    </style>
</head>
<body>

    <div id="ui-bar">
        <div class="stat-item"><canvas id="coinIcon" width="20" height="20"></canvas><span id="gold-val">100</span></div>
        <div class="stat-item"><canvas id="visitorIcon" width="20" height="20"></canvas><span id="visit-val">0</span></div>
        <div style="font-size: 16px; color: #fff; opacity: 0.6;" id="room-name">BAZAAR</div>
        <div class="stat-item"><canvas id="giftIcon" width="20" height="20"></canvas><span id="gift-val">0</span></div>
    </div>
    
    <div id="game-wrap">
        <canvas id="gameCanvas" width="600" height="600"></canvas>
        <div id="perks-display"></div>
        <div id="blackjack-ui">
            <h2 id="bj-msg" style="color:var(--gold); margin:0;">BLACKJACK</h2>
            <div id="dealer-hand" class="card-row"></div>
            <div id="player-hand" class="card-row"></div>
            <button id="hit-btn" class="btn" onclick="hit()">HIT (H)</button>
            <button id="stand-btn" class="btn" onclick="stand()">STAND (S)</button>
        </div>
        <div id="dialogue-box">
            <div id="diag-name" style="color:var(--purple); font-size: 14px; margin-bottom: 5px; font-weight: bold;"></div>
            <div id="diag-text" style="font-size: 19px; font-weight: bold; min-height: 60px;"></div>
            <div id="diag-btns" style="margin-top:20px; text-align:right; border-top: 1px solid #ccc; padding-top: 10px;"></div>
        </div>
        <div class="hint" id="interact-hint" style="display:none;">Press [E] or [Enter]</div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Backgrounds
    const bgBazaar = new Image(); bgBazaar.src = 'input_file_0.png'; 
    const bgElion = new Image(); bgElion.src = 'input_file_1.png';
    const bgShop = new Image(); bgShop.src = 'input_file_2.png';
    const bgGarden = new Image(); bgGarden.src = 'garden.png';
    const bgRomantic = new Image(); bgRomantic.src = 'romantic.png'; 

    // Characters
    const sprCoviello = new Image(); sprCoviello.src = 'coviello.png';
    const sprElion = new Image();    sprElion.src = 'elion.png';
    const sprMerchant = new Image(); sprMerchant.src = 'merchant.png';
    const sprCust1 = new Image();    sprCust1.src = 'customer1.png';
    const sprCust2 = new Image();    sprCust2.src = 'customer2.png';
    const sprCust3 = new Image();    sprCust3.src = 'customer3.png';
    const sprCollector = new Image(); sprCollector.src = 'collector.png';
    const sprKiren = new Image();    sprKiren.src = 'kiren.png';
    const sprKiddo = new Image();    sprKiddo.src = 'kiddo.png';
    const sprExplosion = new Image(); sprExplosion.src = 'explosion.png';

    let gold = 100, inventory = [], room = 'CENTER', state = 'WALK';
    let elionSat = 40, visitorCount = 0, kiddoTattling = false; 
    let lastCustTime = Date.now(), lastFlowerTime = Date.now(), keys = {};
    const player = { x: 300, y: 450, color: '#4a6fa5', isMoving: false, speed: 4 };
    let customer = null, flowers = [], elionGhost = null, explosionEffect = null;

    const masterItems = [
        {name: "Enchanted Candy", cost: 15, sat: 5},
        {name: "Starlight Tea", cost: 40, sat: 15},
        {name: "Cosmic Scarf", cost: 80, sat: 25},
        {name: "Silk Pillow", cost: 60, sat: 20},
        {name: "Ancient Coin", cost: 100, sat: 25},
        {name: "Rare Spices", cost: 30, sat: 10}
    ];

    function drawIcons() {
        const cCtx = document.getElementById('coinIcon').getContext('2d'); cCtx.fillStyle = '#ffd700'; cCtx.fillRect(2, 2, 16, 16);
        const vCtx = document.getElementById('visitorIcon').getContext('2d'); vCtx.fillStyle = '#fff'; vCtx.fillRect(6, 2, 8, 8); vCtx.fillRect(4, 10, 12, 8);
        const gCtx = document.getElementById('giftIcon').getContext('2d'); gCtx.fillStyle = '#8e44ad'; gCtx.fillRect(2, 4, 16, 14);
    }
    drawIcons();

    window.onkeydown = e => {
        keys[e.key.toLowerCase()] = true;
        if (state === 'WALK' && (e.key === 'e' || e.key === 'Enter')) handleInteraction();
        if (state === 'ENDING' && (e.key === 'e' || e.key === 'Enter')) advanceEnding();
        if (state === 'BJ' && e.key === 'h') hit();
        if (state === 'BJ' && e.key === 's') stand();
    };
    window.onkeyup = e => keys[e.key.toLowerCase()] = false;

    function checkCollision(nx, ny) {
        if (state !== 'WALK') return true;
        if (room === 'CENTER') {
            if (ny < 120) { if (nx < 200 || nx > 400) return true; }
            if (ny > 180 && ny < 260 && nx > 60 && nx < 540) return true;
            if (customer && customer.state === 'WAIT' && Math.hypot(nx - customer.x, ny - customer.y) < 50) return true;
            if (ny > 580) return true;
        }
        if (room === 'RIGHT') {
            if (ny < 120 || (nx > 450 && ny < 180)) return true;
            if (nx > 230 && nx < 375 && ny > 190 && ny < 440) return true;
            if (Math.hypot(nx - 500, ny - 520) < 60) return true;
            if (ny > 580) return true;
        }
        if (room === 'LEFT') { if (ny < 330 || ny > 580) return true; }
        if (room === 'GARDEN') { if (ny < 100 || ny > 580 || nx < 20 || nx > 580) { if (ny > 580 && nx > 200 && nx < 400) return false; return true; } }
        return false;
    }

    function handleInteraction() {
        if (room === 'CENTER' && customer?.state === 'WAIT') {
            if (Math.abs(player.y - customer.y) < 150 && Math.abs(player.x - customer.x) < 100) {
                if (customer.role === 'DEBT') startDebtEncounter();
                else if (customer.role === 'KIREN') startKirenEncounter();
                else if (customer.role === 'KIDDO') startKiddoEncounter();
                else if (customer.role === 'GAMBLER') startBJ();
                else startSale();
            }
        }
        if (room === 'RIGHT' && Math.hypot(player.x - 500, player.y - 520) < 120) openElionMenu();
        if (room === 'LEFT' && player.y < 450 && Math.abs(player.x - 300) < 150) openShop();
        if (room === 'GARDEN') { flowers = flowers.filter(f => { if (Math.hypot(player.x - f.x, player.y - f.y) < 40) { inventory.push("Wildflower"); document.getElementById('gift-val').innerText = inventory.length; return false; } return true; }); }
    }

    // --- DIALOGUE REWRITES ---

    function startKiddoEncounter() {
        state = 'DIALOGUE'; const box = document.getElementById('dialogue-box'); box.style.display = 'block';
        document.getElementById('diag-name').innerText = "KIDDO";
        document.getElementById('diag-text').innerText = "'Mister, mister! Have you seen the Enchanted Candy at the shop? It looks like literal sparkles! Can I have some? Please?'";
        let hasCandy = inventory.includes("Enchanted Candy");
        let btns = hasCandy ? `<button class="btn" onclick="giveCandy()">Hand over candy</button>` : "";
        btns += `<button class="btn" onclick="refuseKiddo()">I don't have any candy.</button>`;
        document.getElementById('diag-btns').innerHTML = btns;
    }
    function giveCandy() { inventory.splice(inventory.indexOf("Enchanted Candy"), 1); document.getElementById('gift-val').innerText = inventory.length; document.getElementById('diag-text').innerText = "'WOW! It really is magic! Thank you, kind merchant mister!'"; document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="finishSale()">She skips away happily.</button>`; }
    function refuseKiddo() { document.getElementById('diag-text').innerText = "'YOU'RE A LIAR! I'm telling Elion you're a mean scammer and you're stealing from kids!'"; document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="kiddoRunsAway()">Wait, it was a joke!</button>`; }
    function kiddoRunsAway() { closeDiag(); if(customer) { customer.state = 'OUT'; customer.targetX = 700; } kiddoTattling = true; }

    function startDebtEncounter() {
        state = 'DIALOGUE'; document.getElementById('dialogue-box').style.display = 'block';
        document.getElementById('diag-name').innerText = "COLLECTOR";
        document.getElementById('diag-text').innerText = "'The bazaar isn't free, Coviello. 100 Gold for the monthly protection tax. Don't make this difficult.'";
        let btns = gold >= 100 ? `<button class="btn" onclick="payDebt()">Pay 100G</button>` : `<button class="btn" disabled>Not enough gold</button>`;
        btns += `<button class="btn" onclick="triggerIntervention()">Refuse to pay.</button>`;
        document.getElementById('diag-btns').innerHTML = btns;
    }
    function payDebt() { gold -= 100; document.getElementById('gold-val').innerText = gold; finishSale(); }
    function triggerIntervention() { closeDiag(); state = 'INTERVENTION'; elionGhost = { x: 500, y: 520, targetX: 230, targetY: 140, opacity: 0, stage: 'TELEPORT' }; elionSat = Math.max(0, elionSat - 50); }

    function startSale() {
        state = 'DIALOGUE'; document.getElementById('dialogue-box').style.display = 'block';
        let profit = elionSat >= 50 ? (Math.floor(Math.random() * 11) + 15) : (Math.floor(Math.random() * 11) + 5); 
        gold += profit; document.getElementById('gold-val').innerText = gold;
        document.getElementById('diag-name').innerText = "SHOPPER";
        const lines = [
            `'These spices... they smell like the mountains of my childhood. I'll pay ${profit} gold for the whole jar.'`,
            `'This fabric is woven so tightly! It will make a fine cloak. Here, ${profit} gold for your skill.'`,
            `'I've looked all over the bazaar, but your goods are the finest. Please, take this ${profit} gold.'`,
            `'A rare find indeed! I didn't expect to see such quality today. Here is ${profit} gold.'`
        ];
        document.getElementById('diag-text').innerText = lines[Math.floor(Math.random()*lines.length)];
        document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="finishSale()">Enjoy your purchase!</button>`;
    }
    function finishSale() { closeDiag(); if(customer) customer.state = 'OUT'; }
    function startKirenEncounter() { state = 'DIALOGUE'; document.getElementById('dialogue-box').style.display = 'block'; document.getElementById('diag-name').innerText = "KIREN"; document.getElementById('diag-text').innerText = "'Cov! Look at you, the master of the bazaar. I'm just passing through on my way to the coast, but I had to stop and see my favorite merchant.'"; document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="finishSale()">Safe travels, Kiren!</button>`; }

    function update() {
        if (state === 'ENDING') return;
        if (state === 'INTERVENTION') {
            if (elionGhost.stage === 'TELEPORT') { elionGhost.opacity += 0.02; if (elionGhost.opacity >= 1) { elionGhost.x = elionGhost.targetX; elionGhost.y = elionGhost.targetY; elionGhost.stage = 'CHARGE'; elionGhost.timer = 120; } }
            else if (elionGhost.stage === 'CHARGE') { elionGhost.timer--; if (elionGhost.timer <= 0) { elionGhost.stage = 'BLAST'; explosionEffect = { x: customer.x, y: customer.y, size: 0, alpha: 1 }; } }
            else if (elionGhost.stage === 'BLAST') { customer.x += 4; explosionEffect.size += 3; if (customer.x > 700) elionGhost.stage = 'FADE'; }
            else if (elionGhost.stage === 'FADE') { elionGhost.opacity -= 0.015; explosionEffect.alpha -= 0.01; if (elionGhost.opacity <= 0) { state = 'WALK'; elionGhost = null; explosionEffect = null; customer = null; lastCustTime = Date.now(); } }
            return;
        }

        if (state !== 'WALK') return;
        if (elionSat >= 25) player.speed = 6;
        else if (elionSat < 20) player.speed = 2.5;
        else player.speed = 4;

        let perkList = [];
        if (elionSat < 20) perkList.push("üí§ Sluggish");
        if (elionSat >= 25) perkList.push("‚ö° Haste");
        if (elionSat >= 50) perkList.push("üí∞ Gilded Tongue");
        if (elionSat >= 75) perkList.push("üëÅÔ∏è Oracle");
        document.getElementById('perks-display').innerText = perkList.join(" | ");

        let mx = 0, my = 0;
        if (keys['w'] || keys['arrowup']) my -= player.speed; if (keys['s'] || keys['arrowdown']) my += player.speed; if (keys['a'] || keys['arrowleft']) mx -= player.speed; if (keys['d'] || keys['arrowright']) mx += player.speed;
        if (!checkCollision(player.x + mx, player.y + my)) { player.x += mx; player.y += my; player.isMoving = (mx !== 0 || my !== 0); } else player.isMoving = false;
        
        if (player.x < -15) { if (room === 'CENTER') { room = 'LEFT'; player.x = 580; } else if (room === 'RIGHT') { room = 'CENTER'; player.x = 580; } } 
        else if (player.x > 615) { if (room === 'CENTER') { room = 'RIGHT'; player.x = 20; } else if (room === 'LEFT') { room = 'CENTER'; player.x = 20; } } 
        else if (player.y < -15 && room === 'CENTER') { room = 'GARDEN'; player.y = 570; }
        else if (player.y > 615 && room === 'GARDEN') { room = 'CENTER'; player.y = 50; }

        if (room === 'CENTER' && !customer && Date.now() - lastCustTime > 7000) {
            let r = Math.random();
            let role = r<0.05?'DEBT':(r<0.07?'KIREN':(r<0.12?'KIDDO':(r<0.5?'GAMBLER':'SHOPPER')));
            let skin = Math.random()>0.66?sprCust3:(Math.random()>0.33?sprCust2:sprCust1);
            if(role==='DEBT') skin=sprCollector; if(role==='KIREN') skin=sprKiren; if(role==='KIDDO') skin=sprKiddo;
            customer = { x: 300, y: -50, targetY: 140, state: 'IN', role: role, skin: skin, bet: Math.floor(Math.random()*40)+10 };
        }
        if (customer) {
            if (customer.state === 'IN') { customer.y += 2; if(customer.y >= customer.targetY) { customer.state = 'WAIT'; visitorCount++; document.getElementById('visit-val').innerText = visitorCount; } }
            else if (customer.state === 'OUT') { if(customer.targetX) customer.x += 4; else customer.y -= 3; if(customer.y < -50 || customer.x > 650) { customer = null; lastCustTime = Date.now(); } }
        }
        if (room === 'GARDEN' && flowers.length < 5 && Date.now() - lastFlowerTime > 10000) { flowers.push({x: 50 + Math.random()*500, y: 150 + Math.random()*350, c: `hsl(${Math.random()*360}, 70%, 60%)`}); lastFlowerTime = Date.now(); }
        
        const nearFlower = room === 'GARDEN' && flowers.some(f => Math.hypot(player.x - f.x, player.y - f.y) < 40);
        const nearCust = room === 'CENTER' && customer?.state === 'WAIT' && Math.abs(player.y - customer.y) < 150;
        const nearElion = room === 'RIGHT' && Math.hypot(player.x - 500, player.y - 520) < 120;
        const nearShop = room === 'LEFT' && player.y < 450;
        document.getElementById('interact-hint').style.display = (nearFlower || nearCust || nearElion || nearShop) ? 'block' : 'none';
        document.getElementById('room-name').innerText = room;
        if (elionSat >= 100) triggerEnding();
    }

    function triggerEnding() {
        state = 'ENDING'; canvas.style.opacity = '0';
        setTimeout(() => {
            room = 'ROMANTIC'; canvas.style.opacity = '1';
            document.getElementById('ui-bar').style.display = 'none';
            document.getElementById('dialogue-box').classList.add('ending-mode');
            player.x = 250; player.y = 450;
            openEndingDialogue();
        }, 1000);
    }

    let endStep = 0;
    function openEndingDialogue() { document.getElementById('dialogue-box').style.display = 'block'; advanceEnding(); }
    function advanceEnding() {
        const text = document.getElementById('diag-text'), name = document.getElementById('diag-name'), btns = document.getElementById('diag-btns');
        endStep++;
        if (endStep === 1) { name.innerText = "ELION"; text.innerText = "'I finally understand why you love this view so much, Coviello.'"; btns.innerHTML = `<button class="btn" onclick="advanceEnding()">Next</button>`; }
        else if (endStep === 2) { name.innerText = "COVIELLO"; text.innerText = "'It's not just the view. It's the peace... the kind I only find when I'm with you.'"; }
        else if (endStep === 3) { name.innerText = "ELION"; text.innerText = "'You're so stubborn. All those flowers and gifts... you worked so hard. I suppose I should reward you.'"; }
        else if (endStep === 4) { name.innerText = "COVIELLO"; text.innerText = "'I love you, Elion.'"; }
        else if (endStep === 5) { name.innerText = "ELION"; text.innerText = "'...I love you too. Don't make me say it again, it's exhausting.'"; btns.innerHTML = `<button class="btn" onclick="location.reload()">The End (Replay?)</button>`; }
    }

    function draw() {
        ctx.clearRect(0,0,600,600);
        if (room === 'CENTER') { ctx.drawImage(bgBazaar, 0, 0, 600, 600); if (customer) drawEntity(customer.skin, customer.x, customer.y, customer.role === 'GAMBLER' ? `GAMBLER (${customer.bet}G)` : customer.role, customer.state !== 'WAIT', '#e74c3c'); }
        else if (room === 'RIGHT') { ctx.drawImage(bgElion, 0, 0, 600, 600); drawEntity(sprElion, 500, 520, 'ELION', false, '#2ecc71'); ctx.fillStyle = "#222"; ctx.fillRect(450, 440, 100, 6); ctx.fillStyle = elionSat > 30 ? "#9b59b6" : "#e74c3c"; ctx.fillRect(450, 440, elionSat, 6); }
        else if (room === 'LEFT') { ctx.drawImage(bgShop, 0, 0, 600, 600); drawEntity(sprMerchant, 300, 260, 'MERCHANT', false, '#9b59b6'); }
        else if (room === 'GARDEN') { if (bgGarden.complete && bgGarden.naturalWidth > 0) ctx.drawImage(bgGarden, 0, 0, 600, 600); else { ctx.fillStyle = 'var(--leaf)'; ctx.fillRect(0,0,600,600); } flowers.forEach(f => { ctx.fillStyle = f.c; ctx.beginPath(); ctx.arc(f.x, f.y, 8, 0, Math.PI*2); ctx.fill(); }); }
        else if (room === 'ROMANTIC') { ctx.drawImage(bgRomantic, 0, 0, 600, 600); drawEntity(sprElion, 350, 450, 'ELION', false, '#2ecc71'); }
        
        if (elionGhost) { ctx.globalAlpha = elionGhost.opacity; drawEntity(sprElion, elionGhost.x, elionGhost.y, "ELION", false, '#9b59b6'); if (elionGhost.stage === 'CHARGE') { ctx.strokeStyle = '#9b59b6'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(elionGhost.x, elionGhost.y, 40 + Math.sin(Date.now()/50)*15, 0, Math.PI*2); ctx.stroke(); } ctx.globalAlpha = 1; }
        if (explosionEffect) { ctx.globalAlpha = explosionEffect.alpha; if (sprExplosion.complete && sprExplosion.naturalWidth > 0) ctx.drawImage(sprExplosion, explosionEffect.x - explosionEffect.size/2, explosionEffect.y - explosionEffect.size/2, explosionEffect.size, explosionEffect.size); else { ctx.fillStyle = 'rgba(155, 89, 182, 0.6)'; ctx.beginPath(); ctx.arc(explosionEffect.x, explosionEffect.y, explosionEffect.size, 0, Math.PI*2); ctx.fill(); } ctx.globalAlpha = 1; }
        drawEntity(sprCoviello, player.x, player.y, 'COVIELLO', player.isMoving, '#4a6fa5');
    }

    function drawEntity(img, x, y, name, walk, color) {
        let b = walk ? Math.sin(Date.now()/120) * 6 : 0;
        let s = 90;
        if (!img || !img.complete || img.naturalWidth === 0) { ctx.fillStyle = color; ctx.fillRect(x-30, y-30+b, 60, 60); }
        else { ctx.drawImage(img, x - (s/2), y - (s/2) + b, s, s); }
        ctx.fillStyle = 'white'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center'; ctx.fillText(name, x, y - 50 + b);
    }

    function openElionMenu() {
        state = 'DIALOGUE'; const box = document.getElementById('dialogue-box'); box.style.display = 'block'; document.getElementById('diag-name').innerText = "ELION THE WITCH";
        if (kiddoTattling) { document.getElementById('diag-text').innerText = "'Coviello! I heard you were scamming a child! I thought you were better than that. I'm taking my magic back until you prove you've changed.'"; elionSat = 0; kiddoTattling = false; document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="closeDiag()">Wait, I can explain!</button>`; return; }
        
        let pool = [
            "'Ah, Cov... my favorite distraction. I was just dreaming of stardust.'",
            "'The moon is high, but my energy is low. What brings you to my pillows, friend?'",
            "'Magic is just a shortcut for people who don't want to walk. I've taken many shortcuts today.'",
            "'You smell like bazaar dust and ambition. It's... a grounding scent.'",
            "'Careful where you step, Coviello. I'm testing a new luck charm on the floor.'"
        ];
        document.getElementById('diag-text').innerText = elionSat > 0 ? pool[Math.floor(Math.random()*pool.length)] : "'My magic is cold today, Coviello. Don't ask for much.'";
        document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="elionChat()">Chat more</button><button class="btn" onclick="elionRequestGold()">Ask Gold</button>` + (inventory.length > 0 ? `<button class="btn" onclick="elionGiveGift()">Give Gift</button>` : "") + `<button class="btn" style="background:#555" onclick="closeDiag()">Leave</button>`;
    }
    function elionChat() { 
        const chats = ["'The stars whispered your name earlier. Or maybe it was just a draft.'", "'Magic is exhausting, but seeing you scurrying about makes it a bit more bearable.'", "'The Merchant's 'rare tea' is just dried grass from my garden. Don't tell him I know.'"];
        document.getElementById('diag-text').innerText = chats[Math.floor(Math.random()*chats.length)]; 
    }
    function elionRequestGold() { if (elionSat <= 0) document.getElementById('diag-text').innerText = "'I have no energy to conjure coin for you. Try a gift first.'"; else if (gold > 30) document.getElementById('diag-text').innerText = "'You've got plenty of coin, greedy beetle. Save my magic for when you're truly desperate.'"; else { elionSat = Math.max(0, elionSat - 30); gold += 50; document.getElementById('gold-val').innerText = gold; document.getElementById('diag-text').innerText = "'*Sigh*... Fine. But try not to lose it all at the cards, okay?'"; } }
    function elionGiveGift() { const itemObj = inventory.shift(); const itemInfo = masterItems.find(i => i.name === itemObj); elionSat = Math.min(100, elionSat + (itemInfo ? itemInfo.sat : 5)); document.getElementById('gift-val').innerText = inventory.length; document.getElementById('diag-text').innerText = `'A ${itemObj}? You're far too good to me, Cov. I suppose I'll keep you around.'`; document.getElementById('diag-btns').innerHTML = `<button class="btn" onclick="closeDiag()">I'm glad.</button>`; }

    function openShop() {
        state = 'SHOP'; document.getElementById('dialogue-box').style.display = 'block'; document.getElementById('diag-name').innerText = "THE MERCHANT";
        const intros = ["'Gold is the only language everyone speaks in this bazaar.'", "'Step closer! Only slightly cursed goods today!'", "'Profit is the sun that never sets, my friend. What can I get you?'"];
        document.getElementById('diag-text').innerText = intros[Math.floor(Math.random()*intros.length)];
        const shuffled = [...masterItems].filter(i => i.name !== "Enchanted Candy").sort(() => 0.5 - Math.random()).slice(0, 3);
        const stock = [{name: "Enchanted Candy", cost: 15}, ...shuffled];
        let btns = ""; stock.forEach(item => { btns += `<button class="btn" onclick="buy('${item.name}', ${item.cost})">${item.name} (${item.cost}G)</button>`; });
        btns += `<button class="btn" style="background:#555" onclick="closeDiag()">Exit</button>`;
        document.getElementById('diag-btns').innerHTML = btns;
    }
    function buy(name, price) { if (gold >= price) { gold -= price; inventory.push(name); document.getElementById('gold-val').innerText = gold; document.getElementById('gift-val').innerText = inventory.length; document.getElementById('diag-text').innerText = `'An excellent choice! The ${name} is yours.'`; } else document.getElementById('diag-text').innerText = "'No gold, no goods, traveler!'"; }
    function closeDiag() { document.getElementById('dialogue-box').style.display = 'none'; state = 'WALK'; }

    function hit() { if (state !== 'BJ') return; pHand.push(deck.pop()); renderBJ(); if (getSum(pHand) > 21) endBJ('LOSE'); }
    function stand() { if (state !== 'BJ') return; while(getSum(dHand) < 17) dHand.push(deck.pop()); renderBJ(); let p = getSum(pHand), d = getSum(dHand); if (d > 21 || p > d) endBJ('WIN'); else if (p < d) endBJ('LOSE'); else endBJ('DRAW'); }
    function getSum(h) { let s = h.reduce((a,b)=>a+b.w, 0), aces = h.filter(c=>c.x==='A').length; while(s > 21 && aces > 0) { s -= 10; aces--; } return s; }
    function startBJ() { if (gold < customer.bet) return alert("Not enough gold!"); state = 'BJ'; document.getElementById('blackjack-ui').style.display = 'block'; pHand = []; dHand = []; deck = []; const v = ['2','3','4','5','6','7','8','9','10','J','Q','K','A']; for(let i=0; i<4; i++) v.forEach(x => deck.push({x, w: isNaN(x)?(x==='A'?11:10):parseInt(x)})); deck.sort(() => Math.random() - 0.5); pHand = [deck.pop(), deck.pop()]; dHand = [deck.pop(), deck.pop()]; renderBJ(); }
    function renderBJ() { const pR = document.getElementById('player-hand'), dR = document.getElementById('dealer-hand'); pR.innerHTML = ''; dR.innerHTML = ''; pHand.forEach(c => pR.innerHTML += `<div class="card">${c.x}</div>`); dHand.forEach((c,i) => { let isHidden = (i===1 && state==='BJ' && elionSat < 75); dR.innerHTML += `<div class="card" style="${isHidden?'background:#333':''}">${isHidden?'?':c.x}</div>`; }); }
    function endBJ(res) { state = 'BJ_RESULT'; document.getElementById('bj-msg').innerText = res; gold += (res === 'WIN' ? customer.bet : (res === 'LOSE' ? -customer.bet : 0)); document.getElementById('gold-val').innerText = gold; setTimeout(() => { document.getElementById('blackjack-ui').style.display = 'none'; if(customer) customer.state = 'OUT'; state = 'WALK'; }, 1500); }

    function loop() { update(); draw(); requestAnimationFrame(loop); }
    loop();
</script>
</body>
</html>